<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <title>Bugout Dynamo concept</title>
  <script src="https://chr15m.github.io/bugout/bugout.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/brython@3.8.10/brython.min.js">
</script>
</head>
<body onLoad="js_main()">
  <h1>Bugout Dynamo concept</h1>
  <input id="address"></input><button id="ping">Ping</button>
  <h2>Peers:</h2>
  <pre id="peers"></pre>
  <h2>Log:</h2>
  <pre id="log"></pre>
</body>
<script type="text/python">
from browser import window, console, document 

print("Brython initializing...")
TIMEOUT = 10000
HEARTBEAT = 5000
peers = []

def ping_button(e):
    target_field = document.getElementById("address")
    target_address = str(target_field.value)
    randnum = int(window.Math.random() * 100)
    log("Pinging " + target_address + " with " + str(randnum) + "..." )
    b = window.b
    b.rpc(target_address, "ping", {"num": randnum}, lambda x: log("ok, received: " + str(x["num"])))

def seen(addr):
    log("seen: " + addr)
    peers.append(addr)
    peers_pre = document.getElementById("peers")
    peers_pre.text = '\n'.join(peers)

def left(addr):
    log("left: " + addr)
    try:
        peers.remove(addr)
    except Exception as e: pass
    peers_pre = document.getElementById("peers")
    peers_pre.text = '\n'.join(peers)

def timeout(addr):
    log("timeout: " + addr)
    peers.remove(addr)
    peers_pre = document.getElementById("peers")
    peers_pre.text = '\n'.join(peers)

def ping(addr, args, cb):
    log("pinged by: " + addr)
    log("Received arg num: " + str(args["num"]))
    args["num"] = args["num"] ** 2
    log("Returning: " + str(args["num"]))
    window.call_js_function(cb, args)

def connections(c):
    global connected
    if c == 0 and connected == False:
      connected = True
      log("Connected to the network.")
    log("connections: " + str(c))

def message(addr, msg):
    log("message: " + address + " " + msg)

def rpc(address, call, args, x):
    try:
        log("rpc: " + str(address) + " " + str(call) + " " + str(args) + " " + str(x))
    except Exception as e:
        log("!!! Exception in rpc: " + str(e))
    for arg in args:
        log(arg)

def python_init():
    Bugout = window.bugout_class
    b = Bugout("bugout-dynamo", {"timeout": TIMEOUT})
    window.b = b
    document.getElementById("ping").bind("click", ping_button)
    b.on("seen", seen)
    b.on("timeout", timeout)
    b.on("left", left)
    b.on("connections", connections)
    b.on("rpc", rpc)
    b.register("ping", ping)
    b.heartbeat(HEARTBEAT)

    log("Bugout Dynamo concept")
    log("")
    log("My seed is: " + b.seed)
    log("My address is: " + b.address())


def log(msg):
    document.getElementById("log").textContent += msg + "\n"
    
connected = False
python_init()
# Export functions to JS namespace
window.log = log
</script>
<script>
function call_js_function(fn, args) {
    return fn(args)
}

function js_main() {
  // Make Bugout accessible to Brython
  window.bugout_class = Bugout
  window.call_js_function = call_js_function
  // Perform Brython initialization
  brython()
}
</script>
<style>
  body { background-color: #fff; }
  pre { width:30em; padding:3em; white-space: pre-wrap; word-wrap: break-word; line-height: 1em; }
  #log { background-color:#333; color: #eee; }
  #peers { background-color:#eee; color:#222; }
</style>
</html>
